<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="源码基于 sdk 30（Android 11.0&#x2F;R）。  Android 事件机制包含系统启动流程、输入管理(InputManager)、系统服务和 UI 的通信(WindowManagerService + ViewRootImpl + Window)、事件分发等一系列的环节。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android View 事件传递机制">
<meta property="og:url" content="http://example.com/2022/02/02/Android-View-%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="Vance 的博客">
<meta property="og:description" content="源码基于 sdk 30（Android 11.0&#x2F;R）。  Android 事件机制包含系统启动流程、输入管理(InputManager)、系统服务和 UI 的通信(WindowManagerService + ViewRootImpl + Window)、事件分发等一系列的环节。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E4%BD%93%E7%B3%BB.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png">
<meta property="article:published_time" content="2022-02-02T11:50:48.000Z">
<meta property="article:modified_time" content="2023-03-05T02:30:41.118Z">
<meta property="article:author" content="Vance">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="View">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6.png">


<link rel="canonical" href="http://example.com/2022/02/02/Android-View-%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/02/02/Android-View-%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/","path":"2022/02/02/Android-View-事件传递机制/","title":"Android View 事件传递机制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Android View 事件传递机制 | Vance 的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Vance 的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">事件架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InputEvent%EF%BC%9A%E8%BE%93%E5%85%A5%E4%BA%8B%E4%BB%B6%E6%8A%BD%E8%B1%A1"><span class="nav-number">1.1.</span> <span class="nav-text">InputEvent：输入事件抽象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputManager%EF%BC%9A%E8%BE%93%E5%85%A5%E7%AE%A1%E7%90%86%E5%99%A8"><span class="nav-number">1.2.</span> <span class="nav-text">InputManager：输入管理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputEventReceiver%EF%BC%9A%E4%BA%8B%E4%BB%B6%E6%8E%A5%E6%94%B6%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">InputEventReceiver：事件接收器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputChannel"><span class="nav-number">1.4.</span> <span class="nav-text">InputChannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InputStage"><span class="nav-number">1.5.</span> <span class="nav-text">InputStage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">事件传递流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">Activity 的事件处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewGroup-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.2.</span> <span class="nav-text">ViewGroup 的事件处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#View-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text">View 的事件处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TouchDelegate"><span class="nav-number">4.</span> <span class="nav-text">TouchDelegate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81"><span class="nav-number">5.</span> <span class="nav-text">View 滑动冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-number">6.</span> <span class="nav-text">FAQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Vance</p>
  <div class="site-description" itemprop="description">问道有先后，如是而已。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/02/Android-View-%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Vance">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vance 的博客">
      <meta itemprop="description" content="问道有先后，如是而已。">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Android View 事件传递机制 | Vance 的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android View 事件传递机制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-02 19:50:48" itemprop="dateCreated datePublished" datetime="2022-02-02T19:50:48+08:00">2022-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/View/" itemprop="url" rel="index"><span itemprop="name">View</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>源码基于 sdk 30（Android 11.0&#x2F;R）。</p>
</blockquote>
<p>Android 事件机制包含系统启动流程、输入管理(InputManager)、系统服务和 UI 的通信(WindowManagerService + ViewRootImpl + Window)、事件分发等一系列的环节。</p>
<span id="more"></span>

<p>Android 系统中将输入事件定义为 InputEvent，根据输入事件的类型又分为了 KeyEvent（键盘事件） 和 MotionEvent（屏幕触摸事件）。这些事件统一由系统输入管理器 InputManager 进行分发。</p>
<p>在系统启动的时候，SystemServer 会启动 WindowManagerService，WMS 在启动的时候通过 InputManager 来负责监控键盘消息。</p>
<p>InputManager 负责从硬件接收输入事件，并将事件通过 ViewRootImpl 分发给当前激活的窗口处理，进而分发给 View。</p>
<p>Window 和 InputManagerService 之间通过 <code>InputChannel</code> 来通信，底层通过 socket 进行通信。</p>
<p>Android Touch 事件的基础知识：</p>
<ol>
<li>所有的 Touch 事件都封装到 <code>MotionEvent</code> 里面。</li>
<li>事件类型分为 <code>ACTION_DOWN</code>(手指按下屏幕的瞬间), <code>ACTION_MOVE</code>(手指在屏幕上移动),<code>ACTION_UP</code>(手指离开屏幕瞬间), <code>ACTION_CANCEL</code>(取消手势，一般由程序产生，不会由用户产生)等。每个事件传递过程都是由一个 ACTION_DOWN 开始，经过 n 个 ACTION_MOVE，最终以一个 ACTION_UP&#x2F;ACTION_CANCEL 结束。</li>
<li>事件处理包括三种情况，分别为：<ol>
<li>传递 View#dispatchTouchEvent(MotionEvent event)</li>
<li>拦截 ViewGroup#onInterceptTouchEvent(MotionEvent ev)</li>
<li>消费 View#OnTouchListener.onTouch(View v, MotionEvent event) 和 View#onTouchEvent(MotionEvent event)。</li>
</ol>
</li>
<li>所有的触摸事件都会到达 Activity，Activity 内部通过 Window 连接着一个 View 的根布局 DecorView，事件会从 Activity 一层一层传递到最内层的 View。</li>
</ol>
<p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6.png" alt="View 事件分发"></p>
<h2 id="事件架构"><a href="#事件架构" class="headerlink" title="事件架构"></a>事件架构</h2><p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E4%BD%93%E7%B3%BB.png" alt="Android 事件分发体系"></p>
<h3 id="InputEvent：输入事件抽象"><a href="#InputEvent：输入事件抽象" class="headerlink" title="InputEvent：输入事件抽象"></a>InputEvent：输入事件抽象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Common base class for input events.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InputEvent</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Object used to report key and button events.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeyEvent</span> <span class="keyword">extends</span> <span class="title class_">InputEvent</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Object used to report movement (mouse, pen, finger, trackball) events.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MotionEvent</span> <span class="keyword">extends</span> <span class="title class_">InputEvent</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>KeyEvent 对应了键盘的输入事件；MotionEvent 就是手势事件，鼠标、笔、手指、轨迹球等相关输入设备的事件都属于 MotionEvent。</p>
<h3 id="InputManager：输入管理器"><a href="#InputManager：输入管理器" class="headerlink" title="InputManager：输入管理器"></a>InputManager：输入管理器</h3><p>InputEvent 统一由 InputManager 进行分发，负责与硬件通信并接收输入事件。</p>
<p>system_server 进程启动时会创建 InputManagerService 服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SystemServer.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">(<span class="meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;</span><br><span class="line">    <span class="type">InputManagerService</span> <span class="variable">inputManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputManagerService</span>(context);</span><br><span class="line">    <span class="comment">// 实例化 InputManagerCallback</span></span><br><span class="line">    <span class="type">WindowManagerService</span> <span class="variable">wm</span> <span class="operator">=</span> WindowManagerService.main(context, inputManager, ...);</span><br><span class="line">    inputManager.setWindowManagerCallbacks(wm.getInputManagerCallback());</span><br><span class="line">    inputManager.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InputManagerService</span> <span class="keyword">extends</span> <span class="title class_">IInputManager</span>.Stub &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InputManagerService</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mContext = context;</span><br><span class="line">        <span class="built_in">this</span>.mHandler = <span class="keyword">new</span> <span class="title class_">InputManagerHandler</span>(DisplayThread.get().getLooper());</span><br><span class="line">        mPtr = nativeInit(<span class="built_in">this</span>, mContext, mHandler.getLooper().getQueue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">nativeInit</span><span class="params">(InputManagerService service,</span></span><br><span class="line"><span class="params">            Context context, MessageQueue messageQueue)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>system_server 进程启动时同时会启动 WMS，WMS 在启动的时候就会通过 IMS 启动 InputManager 来监控键盘消息。</p>
<h3 id="InputEventReceiver：事件接收器"><a href="#InputEventReceiver：事件接收器" class="headerlink" title="InputEventReceiver：事件接收器"></a>InputEventReceiver：事件接收器</h3><p>App 端与服务端建立了双向通信之后，InputManager 就能够将产生的输入事件从底层硬件分发过来，Android 提供了 InputEventReceiver 类，以接收分发这些消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides a low-level mechanism for an application to receive input events.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InputEventReceiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InputEventReceiver</span><span class="params">(InputChannel inputChannel, Looper looper)</span> &#123;</span><br><span class="line">        mInputChannel = inputChannel;</span><br><span class="line">        mMessageQueue = looper.getQueue();</span><br><span class="line">        mReceiverPtr = nativeInit(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;InputEventReceiver&gt;(<span class="built_in">this</span>),</span><br><span class="line">            inputChannel, mMessageQueue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called from native code.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchInputEvent</span><span class="params">(<span class="type">int</span> seq, InputEvent event)</span> &#123;</span><br><span class="line">        mSeqMap.put(event.getSequenceNumber(), seq);</span><br><span class="line">        onInputEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInputEvent</span><span class="params">(InputEvent event)</span> &#123;</span><br><span class="line">        finishInputEvent(event, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">finishInputEvent</span><span class="params">(InputEvent event, <span class="type">boolean</span> handled)</span> &#123;</span><br><span class="line">        nativeFinishInputEvent(mReceiverPtr, seq, handled);</span><br><span class="line">        event.recycleIfNeededAfterDispatch();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewRootImpl.java</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WindowInputEventReceiver</span> <span class="keyword">extends</span> <span class="title class_">InputEventReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInputEvent</span><span class="params">(InputEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// 将输入事件加入队列,开始事件分发</span></span><br><span class="line">        enqueueInputEvent(event, <span class="built_in">this</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InputChannel"><a href="#InputChannel" class="headerlink" title="InputChannel"></a>InputChannel</h3><p>Window 和 IMS 之间通过 InputChannel 通信。InputChannel 是一个 pipe，底层通过 socket 进行通信。在 ViewRootImpl.setView() 过程中注册 InputChannel。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An input channel specifies the file descriptors used to send input events to a window in another process.</span></span><br><span class="line"><span class="comment"> * It is Parcelable so that it can be sent to the process that is to receive events.</span></span><br><span class="line"><span class="comment"> * Only one thread should be reading from an InputChannel at a time.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">InputChannel</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewRootImpl.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setView</span><span class="params">()</span>&#123;</span><br><span class="line">    requestLayout();</span><br><span class="line">    <span class="type">InputChannel</span> <span class="variable">inputChannel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputChannel</span>();</span><br><span class="line">    <span class="comment">// 通过 Binder 在 system_server 进程中完成 InputChannel 的注册</span></span><br><span class="line">    res = mWindowSession.addToDisplayAsUser(mWindow, inputChannel, ...);</span><br><span class="line">    <span class="keyword">if</span> (mInputQueueCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">        mInputQueue = <span class="keyword">new</span> <span class="title class_">InputQueue</span>();</span><br><span class="line">        mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    mInputEventReceiver = <span class="keyword">new</span> <span class="title class_">WindowInputEventReceiver</span>(inputChannel, Looper.myLooper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 InputStage</span></span><br><span class="line">    mSyntheticInputStage = <span class="keyword">new</span> <span class="title class_">SyntheticInputStage</span>();</span><br><span class="line">    <span class="type">InputStage</span> <span class="variable">viewPostImeStage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ViewPostImeInputStage</span>(mSyntheticInputStage);</span><br><span class="line">    <span class="comment">// nativePostImeStage earlyPostImeStage imeStage viewPreImeStage nativePreImeStage</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InputStage"><a href="#InputStage" class="headerlink" title="InputStage"></a>InputStage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Base class for implementing a stage in the chain of responsibility</span></span><br><span class="line"><span class="comment">     * for processing input events.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InputStage</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">onProcess</span><span class="params">(QueuedInputEvent q)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> FORWARD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Delivers post-ime input events to the view hierarchy.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewPostImeInputStage</span> <span class="keyword">extends</span> <span class="title class_">InputStage</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">onProcess</span><span class="params">(QueuedInputEvent q)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (q.mEvent <span class="keyword">instanceof</span> KeyEvent) &#123;</span><br><span class="line">                <span class="keyword">return</span> processKeyEvent(q);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">source</span> <span class="operator">=</span> q.mEvent.getSource();</span><br><span class="line">                <span class="keyword">if</span> ((source &amp; InputDevice.SOURCE_CLASS_POINTER) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> processPointerEvent(q);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((source &amp; InputDevice.SOURCE_CLASS_TRACKBALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> processTrackballEvent(q);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> processGenericMotionEvent(q);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">processPointerEvent</span><span class="params">(QueuedInputEvent q)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MotionEvent</span> <span class="variable">event</span> <span class="operator">=</span> (MotionEvent)q.mEvent;</span><br><span class="line">        <span class="comment">// mView 是 DecorView 类型</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">handled</span> <span class="operator">=</span> mView.dispatchPointerEvent(event);</span><br><span class="line">        <span class="keyword">return</span> handled ? FINISH_HANDLED : FORWARD;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DecorView</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Window.<span class="type">Callback</span> <span class="variable">cb</span> <span class="operator">=</span> mWindow.getCallback();</span><br><span class="line">        <span class="keyword">return</span> cb != <span class="literal">null</span> &amp;&amp; !mWindow.isDestroyed() &amp;&amp; mFeatureId &lt; <span class="number">0</span></span><br><span class="line">                ? cb.dispatchTouchEvent(ev) : <span class="built_in">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>ViewPostImeInputStage</code> 是 Touch 事件传递的起点；</li>
<li>Activity 实现了 Window.Callback 接口，DecorView 会把事件分发到 Activity#dispatchTouchEvent(ev) 方法。</li>
</ol>
<h2 id="事件传递流程"><a href="#事件传递流程" class="headerlink" title="事件传递流程"></a>事件传递流程</h2><p>Android 事件传递机制是<code>先分发再处理</code>，先由外部的 View 接收，然后依次传递给其内层的 View，再从最内层 View 反向依次向外层传递。</p>
<ol>
<li>事件从 <code>Activity#dispatchTouchEvent()</code> 开始传递，再传递给 DecorView；</li>
<li>DecorView 中先执行 <code>dispatchTouchEvent()</code> 方法，在其内部会先调用 <code>onInterceptTouchEvent()</code> 询问是否拦截事件，若拦截则执行 <code>onTouchEvent()</code> 方法处理这个事件；</li>
<li>若不拦截，则执行子 View 的 dispatchTouchEvent() 方法，进入向下分发的传递，直到事件被处理；</li>
<li>如果事件从外向内传递过程中一直没有被拦截，且最底层子 View 没有消费事件，则事件会反向向上传递。这时父 View 可以进行消费，如果还是没有被消费，最后会传递到 Activity#onTouchEvent() 方法；</li>
<li>如果 View 没有对 ACTION_DOWN 进行消费，之后的其它类型的事件也不会传递过来，也就是说 ACTION_DOWN 必须返回 true，之后的事件才会传递进来。</li>
<li>事件处理优先级是<br><code>OnTouhListener#onTouch(View v, MotionEvent event) -&gt; onTouchEvent() -&gt; OnClickListener#onClick(View v)</code>。</li>
</ol>
<p>三个方法的关系如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">consum</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(onInterceptTouchEvent(event))&#123;</span><br><span class="line">        consum = onTouchEvent(event);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        consum = child.dispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> consum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20View%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png" alt="思维导图"></p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="Activity-的事件处理"><a href="#Activity-的事件处理" class="headerlink" title="Activity 的事件处理"></a>Activity 的事件处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            onUserInteraction();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用 mDecor.superDispatchTouchEvent(event);</span></span><br><span class="line">        <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> onTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mWindow.shouldCloseOnTouch(<span class="built_in">this</span>, event)) &#123;</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneWindow</span> <span class="keyword">extends</span> <span class="title class_">Window</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Window</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldCloseOnTouch</span><span class="params">(Context context, MotionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isOutside</span> <span class="operator">=</span></span><br><span class="line">                event.getAction() == MotionEvent.ACTION_UP &amp;&amp; isOutOfBounds(context, event)</span><br><span class="line">                || event.getAction() == MotionEvent.ACTION_OUTSIDE;</span><br><span class="line">        <span class="keyword">if</span> (mCloseOnTouchOutside &amp;&amp; peekDecorView() != <span class="literal">null</span> &amp;&amp; isOutside) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>Activity 接收到 ACTION_DOWN 事件后，调用 <code>onUserInteraction()</code> 方法，表示和用户进行了交互；</li>
<li>Activity 接收到事件后经 PhoneWindow 传递给 DecorView；</li>
<li>传递给 DecorView 后如果此事件没有被消费，则事件交给 Activity#onTouchEvent() 处理。</li>
</ol>
<h3 id="ViewGroup-的事件处理"><a href="#ViewGroup-的事件处理" class="headerlink" title="ViewGroup 的事件处理"></a>ViewGroup 的事件处理</h3><p><strong>分发事件：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewGroup.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">handled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ACTION_DOWN 说明是新事件，重置状态</span></span><br><span class="line">    <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        <span class="comment">// 清空 TouchTarget 链表</span></span><br><span class="line">        cancelAndClearTouchTargets(ev);</span><br><span class="line">        <span class="comment">// 重置事件状态</span></span><br><span class="line">        resetTouchState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> intercepted;</span><br><span class="line">    <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">            || mFirstTouchTarget != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断是否拦截事件</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">disallowIntercept</span> <span class="operator">=</span> (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">            <span class="comment">// 如果拦截，事件由当前 ViewGroup 处理</span></span><br><span class="line">            intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">            <span class="comment">// 防止onInterceptTouchEvent()的时候改变Action</span></span><br><span class="line">            ev.setAction(action);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            intercepted = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//没有 TouchTarget 而且非 ACTION_DOWN 类型的事件，由 ViewGroup 处理</span></span><br><span class="line">        intercepted = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果给子View发送cancel事件后mFirstTouchTarget会变null，</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">canceled</span> <span class="operator">=</span> resetCancelNextUpFlag(<span class="built_in">this</span>)</span><br><span class="line">            || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line">    <span class="type">TouchTarget</span> <span class="variable">newTouchTarget</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">alreadyDispatchedToNewTouchTarget</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 事件没有取消也没有拦截，向子 View 传递</span></span><br><span class="line">    <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childrenCount</span> <span class="operator">=</span> mChildrenCount;</span><br><span class="line">            <span class="comment">// 遍历查找第一个消费这个事件的子View，并设置为 Target</span></span><br><span class="line">            <span class="keyword">if</span> (newTouchTarget == <span class="literal">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</span><br><span class="line">                <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                <span class="comment">// 按 View 添加顺序倒序查找</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">View</span> <span class="variable">child</span> <span class="operator">=</span> getAndVerifyPreorderedView(...);</span><br><span class="line">                    <span class="comment">// 判断事件坐标是否在 View 内</span></span><br><span class="line">                    <span class="keyword">if</span> (!child.canReceivePointerEvents()</span><br><span class="line">                            || !isTransformedTouchPointInView(x, y, child, <span class="literal">null</span>)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 更新 target</span></span><br><span class="line">                    newTouchTarget = getTouchTarget(child);</span><br><span class="line">                    <span class="comment">// 分发事件到点击的 View</span></span><br><span class="line">                    <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="literal">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                        <span class="comment">// View 处理该事件，添加到 TouchTarget 调用链，赋值 mFirstTouchTarget</span></span><br><span class="line">                        newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                        alreadyDispatchedToNewTouchTarget = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (newTouchTarget == <span class="literal">null</span> &amp;&amp; mFirstTouchTarget != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Did not find a child to receive the event.</span></span><br><span class="line">                    <span class="comment">// Assign the pointer to the least recently added target.</span></span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFirstTouchTarget == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 没有找到处理此事件的子 View。比如：点击按钮之外</span></span><br><span class="line">            handled = dispatchTransformedTouchEvent(ev, canceled, <span class="literal">null</span>,</span><br><span class="line">                    TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></span><br><span class="line">            <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></span><br><span class="line">            <span class="type">TouchTarget</span> <span class="variable">predecessor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">TouchTarget</span> <span class="variable">target</span> <span class="operator">=</span> mFirstTouchTarget;</span><br><span class="line">            <span class="keyword">while</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">TouchTarget</span> <span class="variable">next</span> <span class="operator">=</span> target.next;</span><br><span class="line">                <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class="line">                    handled = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果拦截了事件，给子 View 发送 cancel 事件</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">cancelChild</span> <span class="operator">=</span> resetCancelNextUpFlag(target.child)</span><br><span class="line">                            || intercepted;</span><br><span class="line">                    <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                            target.child, target.pointerIdBits)) &#123;</span><br><span class="line">                        handled = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 发送 Cancel 事件后，将 target 节点从链表中删除</span></span><br><span class="line">                    <span class="comment">// 也就是为什么 View 收到 cancel 事件后，后续的事件接收不到的原因</span></span><br><span class="line">                    <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (predecessor == <span class="literal">null</span>) &#123;</span><br><span class="line">                            mFirstTouchTarget = next;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            predecessor.next = next;</span><br><span class="line">                        &#125;</span><br><span class="line">                        target.recycle();</span><br><span class="line">                        target = next;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                predecessor = target;</span><br><span class="line">                target = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个参数cancel包含两种含义，一种是外部收到了取消事件，另一种是事件被拦截</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="type">boolean</span> cancel,</span></span><br><span class="line"><span class="params">            View child, <span class="type">int</span> desiredPointerIdBits)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> handled;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">oldAction</span> <span class="operator">=</span> event.getAction();</span><br><span class="line">    <span class="comment">// cancel 事件处理</span></span><br><span class="line">    <span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</span><br><span class="line">        event.setAction(MotionEvent.ACTION_CANCEL);</span><br><span class="line">        <span class="keyword">if</span> (child == <span class="literal">null</span>) &#123;</span><br><span class="line">            handled = <span class="built_in">super</span>.dispatchTouchEvent(event);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handled = child.dispatchTouchEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">        event.setAction(oldAction);</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="literal">null</span>) &#123;</span><br><span class="line">        handled = <span class="built_in">super</span>.dispatchTouchEvent(transformedEvent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        handled = child.dispatchTouchEvent(transformedEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用了树的<code>深度优先搜索算法</code>（Depth-First-Search，简称 DFS 算法），每个 ViewGroup 都持有一个 mFirstTouchTarget, 当接收到 ACTION_DOWN 时，通过递归遍历找到 View 树中真正对事件进行消费的 Child，并保存在 mFirstTouchTarget 属性中，依此类推组成一个完整的分发链。在这之后，当接收到同一事件序列的其它事件如 ACTION_MOVE、ACTION_UP 时，则会跳过递归流程，将事件直接分发给下一级的 Child。</p>
<p>ViewGroup 分发事件的主要的任务是找一个 Target，并且用这个 Target 处理事件，主要逻辑如下 ：</p>
<ol>
<li>在 ACTION_DOWN 事件并且当前 ViewGroup 不拦截时会查找 TouchTarget。按 View 添加顺序倒序遍历子 View，判断子 View 的 dispatchTouchEvent() 是否为 true。查找 TouchTarget 的过程只有在 ACTION_DOWN 事件中才会触发。</li>
<li>如果子 View 的 dispatchTouchEvent() 返回 true，则这个子 View 就是当前 ViewGroup 的 Target。</li>
<li>如果 TouchTarget 不存在，则调用当前 ViewGroup#onTouchEvent() 方法，仍不消费，会向上调传递直到 Activity#onTouchEvent()。</li>
<li>子 View 可以调用父 View 的 requestDisallowInterceptTouchEvent(true) 请求父 View 不拦截此事件，交给 子 View 处理。只限于一个 Touch 过程（Down-&gt;Up&#x2F;Cancel）。</li>
<li>处理 Cancel 事件，将 View 从链表中删除。</li>
</ol>
<p><strong>为什么倒序查找 TouchTarget?</strong><br>如果按添加顺序遍历，当 View 重叠时（FrameLayout），先添加的 View 总是能消费事件，而后添加的 View 不可能获取到事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewGroup.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">childIndex</span> <span class="operator">=</span> ...;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">View</span> <span class="variable">child</span> <span class="operator">=</span> ...;</span><br><span class="line">        <span class="comment">// 重叠的子 View 都包含点击区域</span></span><br><span class="line">        <span class="keyword">if</span> (!child.canReceivePointerEvents()</span><br><span class="line">                || !isTransformedTouchPointInView(x, y, child, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 非容器 View 默认都会消费事件，从而跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="literal">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">            newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">            alreadyDispatchedToNewTouchTarget = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>拦截事件：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewGroup.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ev.isFromSource(InputDevice.SOURCE_MOUSE)</span><br><span class="line">            &amp;&amp; ev.getAction() == MotionEvent.ACTION_DOWN</span><br><span class="line">            &amp;&amp; ev.isButtonPressed(MotionEvent.BUTTON_PRIMARY)</span><br><span class="line">            &amp;&amp; isOnScrollbarThumb(ev.getX(), ev.getY())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>默认返回 false，不拦截事件。</li>
<li>ViewGroup 子类可以重写该方法，决定是否拦截事件。</li>
<li>子 View 通过 <code>parentView.requestDisallowInterceptTouchEvent(true)</code> 请求父 View 不拦截此事件。</li>
</ol>
<h3 id="View-的事件处理"><a href="#View-的事件处理" class="headerlink" title="View 的事件处理"></a>View 的事件处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// View.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        event.setTargetAccessibilityFocus(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止嵌套滑动</span></span><br><span class="line">    <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        stopNestedScroll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 View 可用并设置了 OnTouchListener，如果回调方法 onTouch() 返回 true 则消费事件</span></span><br><span class="line">    <span class="comment">// 并且不会调用 onTouchEvent() 方法</span></span><br><span class="line">    <span class="type">ListenerInfo</span> <span class="variable">li</span> <span class="operator">=</span> mListenerInfo;</span><br><span class="line">    <span class="keyword">if</span> (li != <span class="literal">null</span> &amp;&amp; li.mOnTouchListener != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">            &amp;&amp; li.mOnTouchListener.onTouch(<span class="built_in">this</span>, event)) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>安全监测。如果 View#setFilterTouchesWhenObscured(true) 开启了安全检测，当 View 所在的 Window 被覆盖时不处理 Touch 事件；</li>
<li>停止嵌套滑动（5.0 以后添加）；</li>
<li>View 可用时才调用 OnTouchListener#onTouch() 方法；</li>
<li>不管 View 是否可用，只要 OnTouchListener 不消费事件，就会让 onTouchEvent() 处理；</li>
<li>View 不可用时，不处理 OnTouchListener#onTouchEvent()，直接调用 View#onTouchEvent() 方法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// View.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">// 判断是否可以点击</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">clickable</span> <span class="operator">=</span> ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">            || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// View 不可用时可以消费事件，只是没有响应</span></span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">            setPressed(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clickable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件代理</span></span><br><span class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不管是否可用，只有是可点击的就消费事件</span></span><br><span class="line">    <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">prepressed</span> <span class="operator">=</span> (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 只有在 press 的情况下，才 click，longClick</span></span><br><span class="line">                <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</span><br><span class="line">                    <span class="comment">// 如果我们在当前View还没获取焦点，并且能在touch下foucus</span></span><br><span class="line">                    <span class="comment">// 那么第一次点击只会将这个View的状态改成focus，而不会触发click</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">focusTaken</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                        focusTaken = requestFocus();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 设置 Pressed 状态，更新 View 背景</span></span><br><span class="line">                    <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                        setPressed(<span class="literal">true</span>, x, y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 检查 longClick 是否已执行</span></span><br><span class="line">                    <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                        <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Only perform take click actions if we were in the pressed state</span></span><br><span class="line">                        <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">                            <span class="comment">// Use a Runnable and post this rather than calling</span></span><br><span class="line">                            <span class="comment">// performClick directly. This lets other visual state</span></span><br><span class="line">                            <span class="comment">// of the view update before click actions start.</span></span><br><span class="line">                            <span class="keyword">if</span> (mPerformClick == <span class="literal">null</span>) &#123;</span><br><span class="line">                                mPerformClick = <span class="keyword">new</span> <span class="title class_">PerformClick</span>();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">                                performClickInternal();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!clickable) &#123;</span><br><span class="line">                    <span class="comment">// 400 ms</span></span><br><span class="line">                    checkForLongClick(ViewConfiguration.getLongPressTimeout(),...);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isInScrollingContainer</span> <span class="operator">=</span> isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isInScrollingContainer) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    setPressed(<span class="literal">true</span>, x, y);k</span><br><span class="line">                    <span class="title function_">checkForLongClick</span><span class="params">(ViewConfiguration.getLongPressTimeout()</span>,...);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                <span class="keyword">if</span> (clickable) &#123;</span><br><span class="line">                    setPressed(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="keyword">if</span> (clickable) &#123;</span><br><span class="line">                    drawableHotspotChanged(x, y);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">motionClassification</span> <span class="operator">=</span> event.getClassification();</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ambiguousGesture</span> <span class="operator">=</span> ...;</span><br><span class="line">                <span class="type">int</span> <span class="variable">touchSlop</span> <span class="operator">=</span> mTouchSlop;</span><br><span class="line">                <span class="keyword">if</span> (ambiguousGesture &amp;&amp; hasPendingLongPressCallback()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!pointInView(x, y, touchSlop)) &#123;</span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line">                        checkForLongClick(...);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Be lenient about moving outside of buttons</span></span><br><span class="line">                <span class="keyword">if</span> (!pointInView(x, y, touchSlop)) &#123;</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">                        setPressed(<span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">deepPress</span> <span class="operator">=</span> ;</span><br><span class="line">                <span class="keyword">if</span> (deepPress &amp;&amp; hasPendingLongPressCallback()) &#123;</span><br><span class="line">                    <span class="comment">// process the long click action immediately</span></span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    checkForLongClick(...);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果 View 不可用但是可点击，会直接消费事件，只是不做其他任何操作；</li>
<li>如果 View 可用并设置了 TouchDelegate，则事件交给 TouchDelegate 处理；</li>
<li>不管 View 是否可用，只要 View 可点击，默认都会消费事件；</li>
<li>处理 focus，press，click，longclick 等。</li>
</ol>
<h2 id="TouchDelegate"><a href="#TouchDelegate" class="headerlink" title="TouchDelegate"></a>TouchDelegate</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// View.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(MotionEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码看出，如果 View 设置了事件代理，则事件会首先交给 mTouchDelegate 对象处理，如果消费了事件，当前 View 的事件会被拦截。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Helper class to handle situations where you want a view to have a larger touch area than its</span></span><br><span class="line"><span class="comment"> * actual view bounds. The view whose touch area is changed is called the delegate view. This</span></span><br><span class="line"><span class="comment"> * class should be used by an ancestor of the delegate. To use a TouchDelegate, first create an</span></span><br><span class="line"><span class="comment"> * instance that specifies the bounds that should be mapped to the delegate and the delegate</span></span><br><span class="line"><span class="comment"> * view itself.</span></span><br><span class="line"><span class="comment"> * The ancestor should then forward all of its touch events received in its</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> android.view.View#onTouchEvent(MotionEvent)&#125; to &#123;<span class="doctag">@link</span> #onTouchEvent(MotionEvent)&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TouchDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TouchDelegate</span><span class="params">(Rect bounds, View delegateView)</span> &#123;</span><br><span class="line">        mBounds = bounds;</span><br><span class="line"></span><br><span class="line">        mSlop = ViewConfiguration.get(delegateView.getContext()).getScaledTouchSlop();</span><br><span class="line">        mSlopBounds = <span class="keyword">new</span> <span class="title class_">Rect</span>(bounds);</span><br><span class="line">        mSlopBounds.inset(-mSlop, -mSlop);</span><br><span class="line">        mDelegateView = delegateView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouchEvent</span><span class="params">(<span class="meta">@NonNull</span> MotionEvent event)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (<span class="type">int</span>)event.getX();</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> (<span class="type">int</span>)event.getY();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">sendToDelegate</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hit</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">handled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (event.getActionMasked()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                <span class="comment">// DOWN 事件在设置的区域内，消费事件</span></span><br><span class="line">                mDelegateTargeted = mBounds.contains(x, y);</span><br><span class="line">                sendToDelegate = mDelegateTargeted;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                sendToDelegate = mDelegateTargeted;</span><br><span class="line">                <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">                    <span class="type">Rect</span> <span class="variable">slopBounds</span> <span class="operator">=</span> mSlopBounds;</span><br><span class="line">                    <span class="keyword">if</span> (!slopBounds.contains(x, y)) &#123;</span><br><span class="line">                        hit = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                sendToDelegate = mDelegateTargeted;</span><br><span class="line">                mDelegateTargeted = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sendToDelegate) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hit) &#123;</span><br><span class="line">                <span class="comment">// Offset event coordinates to be inside the target view</span></span><br><span class="line">                event.setLocation(mDelegateView.getWidth() / <span class="number">2</span>, mDelegateView.getHeight() / <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Offset event coordinates to be outside the target view (in case it does</span></span><br><span class="line">                <span class="comment">// something like tracking pressed state)</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">slop</span> <span class="operator">=</span> mSlop;</span><br><span class="line">                event.setLocation(-(slop * <span class="number">2</span>), -(slop * <span class="number">2</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            handled = mDelegateView.dispatchTouchEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>bounds 是指消费事件的区域；</li>
<li>mDelegateView 是指消费事件后将事件分发给代理 View；</li>
</ol>
<p>示例一，扩大 View 的点击范围：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 post() 获取 View 的宽高</span></span><br><span class="line">textView.post &#123;</span><br><span class="line">    with(textView) &#123;</span><br><span class="line">        <span class="comment">// textView 在父 View 中的位置</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">rect</span> <span class="operator">=</span> Rect(left, top, left + width, top + height)</span><br><span class="line">        <span class="comment">// 扩大响应范围。负数扩大区域；正数缩小区域</span></span><br><span class="line">        rect.inset(-<span class="number">100</span>, -<span class="number">100</span>)</span><br><span class="line">        <span class="comment">// 给 textView 的父 View 设置代理，将本该属于父 View 的区域代理给了子 View 处理</span></span><br><span class="line">        (parent as View).touchDelegate = TouchDelegate(rect, textView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例二，点击 View 时响应的是其他 View 的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 post() 获取 View 的宽高</span></span><br><span class="line">textView.post &#123;</span><br><span class="line">    with(textView) &#123;</span><br><span class="line">        <span class="comment">// textView 的点击区域</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">rect</span> <span class="operator">=</span> Rect(<span class="number">0</span>, <span class="number">0</span>, right, bottom)</span><br><span class="line">        <span class="comment">// 给 textView 设置代理，如果事件在此区域内，则将事件传递给 anotherView 处理</span></span><br><span class="line">        touchDelegate = TouchDelegate(rect, anotherView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="View-滑动冲突"><a href="#View-滑动冲突" class="headerlink" title="View 滑动冲突"></a>View 滑动冲突</h2><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol>
<li>View.GONE 后仍消费事件的原因？<br>可能该 View 执行了动画，要移除。<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4728908/android-view-with-view-gone-still-receives-ontouch-and-onclick">android View with View.GONE still receives onTouch and onClick</a><br><a target="_blank" rel="noopener" href="https://issuetracker.google.com/issues/36911205">View with visibility View.GONE still generates touch events</a></li>
<li>触摸 button 后滑动到外部抬起会触发点击事件吗？如果再滑动回去会触发吗？<br>不会触发点击事件。因为按下（ACTION_DOWN）时设置了 <code>PFLAG_PRESSED</code> 标记，移动（ACTION_MOVE）到 View 外部后清除了该标记，即使再滑动到 View 内也不会重新设置。当抬起（ACTION_UP）时，判断设置了 PFLAG_PRESSED 才会触发点击事件。</li>
<li>ACTION_CANCEL 事件怎么产生，作用是什么？<br>如果子 View 处理了 ACTION_DOWN 事件，那么正常情况下后面的 ACTION_MOVE 和 ACTION_UP 事件也会交给它处理。但是交给它处理之前，父 View 还是可以拦截事件的，如果拦截了事件，系统会生成 ACTION_CANCEL 事件给子 View，并且不会收到后续的事件，用于重置状态。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>一个点击事件是从 Activity-&gt;Window-&gt;DecorView-&gt;若干 ViewGroup-&gt;View，传递过程如下：<br><code>Activity#dispatchTouchEvent() -&gt; DecorView#dispatchTouchEvent() -&gt; View#OnTouchListener.onTouch() -&gt; View#onTouchEvent() -&gt; View#OnClickListener.onClick()</code>；</li>
<li>如果一个 View 的 onTouchEvent 方法返回 false，那么将会交给父容器的 onTouchEvent 方法进行处理，逐级往上，如果所有的 View 都不处理该事件，则交由 Activity#onTouchEvent() 处理。</li>
<li>ViewGroup 默认不拦截任何事件，可以通过重写 onInterceptTouchEvent() 方法拦截事件，执行自己对应的 onTouchEvent() 方法。</li>
<li>子 View 可以通过调用父 View 的 requestDisallowInterceptTouchEvent(true) 请求 ViewGroup 把事件交给子 View 处理；</li>
<li>如果 ViewGroup 找到了能够处理该事件的 View（TouchTarget），默认情况后续的事件也会直接交给子 View 处理；</li>
<li>如果某一个 View 不消耗 ACTION_DOWN 事件，则同一事件序列中不会再交给该 View 处理；</li>
<li>非容器的 View，一旦接收到事件默认都会消耗事件，除非它是不可点击的（clickable 和 longClickable 都为 false），那么就会由父容器的 onTouchEvent() 处理；</li>
<li>View 的 visible 属性对事件传递没有影响；</li>
<li>如果当前 View 是可点击的，并且它收到了 down 和 up 事件，则它的 click 事件就会触发；对于 onLongClick，则只要当前 View 接收到 down 事件超过了系统默认的时间；</li>
<li>当某个子 View 消费事件时，会中止 Down 事件的分发，同时在 ViewGroup 中记录该子 View。同一序列中的 Move 和 Up 事件将由该子 View 直接进行处理。</li>
<li>当子 View 都不消费 Down 事件时，将调用 ViewGroup#onTouchEvent() 方法。触发的方式是调用 super.dispatchTouchEvent() 函数，即父类 View#dispatchTouchEvent 方法。如果所有子 View 都不处理，则调用 Acitivity#onTouchEvent() 方法。</li>
<li>如果 View 没有对 ACTION_DOWN 进行消费，那后续事件不会传递过来。如果 View 消费了 ACTION_DOWN，在不拦截的情况下，后续事件会直接传递给这个 View；</li>
<li>接收了 ACTION_DOWN 事件的函数不一定能收到后续的 ACTION_MOVE 和 ACTION_UP 事件，有可能事件被父 View 拦截了。</li>
<li><code>如果当前正在处理的事件被父 View 拦截，子 View 会收到一个 ACTION_CANCEL 事件，并从 TouchTarget 链中移除，所以后续事件不会再传递过来。</code></li>
<li>子 View 重叠并都是可点击时，最后添加的 View，即离用户最近的 View 最先消费事件。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903926446161927">[1] Android 事件分发机制的设计与实现</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904128397705230">[2] Android 事件拦截机制的设计与实现</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/View/" rel="tag"># View</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/01/15/Android-View-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/" rel="prev" title="Android View 绘制流程">
                  <i class="fa fa-chevron-left"></i> Android View 绘制流程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/03/02/Android-Jetpack-%E4%B9%8B-ViewBinding-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="next" title="Android Jetpack 之 ViewBinding 源码分析">
                  Android Jetpack 之 ViewBinding 源码分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vance</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
