<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Android 中所有的视图都是通过 Window 来呈现的，像常用的 Activity，Dialog 和 Toast 都是附加在 Window 上的，所以 Window 是 View 的直接管理者。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Window">
<meta property="og:url" content="http://example.com/2022/04/12/Android-Window/index.html">
<meta property="og:site_name" content="Vance 的博客">
<meta property="og:description" content="Android 中所有的视图都是通过 Window 来呈现的，像常用的 Activity，Dialog 和 Toast 都是附加在 Window 上的，所以 Window 是 View 的直接管理者。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%20%E5%9B%BE%E4%BE%8B.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20Uml.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20setContentView.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%E6%B7%BB%E5%8A%A0%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%E6%B7%BB%E5%8A%A0%20IPC%20%E4%BA%A4%E4%BA%92.png">
<meta property="og:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20WindowState.png">
<meta property="article:published_time" content="2022-04-12T15:54:25.000Z">
<meta property="article:modified_time" content="2023-03-05T02:30:41.118Z">
<meta property="article:author" content="Vance">
<meta property="article:tag" content="Window">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%20%E5%9B%BE%E4%BE%8B.png">


<link rel="canonical" href="http://example.com/2022/04/12/Android-Window/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/04/12/Android-Window/","path":"2022/04/12/Android-Window/","title":"Android Window"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Android Window | Vance 的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Vance 的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="nav-number">1.</span> <span class="nav-text">Window 相关类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-LayoutParams"><span class="nav-number">2.</span> <span class="nav-text">Window LayoutParams</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Type"><span class="nav-number">2.1.</span> <span class="nav-text">Window Type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Flag"><span class="nav-number">2.2.</span> <span class="nav-text">Window Flag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Token"><span class="nav-number">2.3.</span> <span class="nav-text">Window Token</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-%E6%B7%BB%E5%8A%A0-View-%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">Window 添加 View 的过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">3.1.</span> <span class="nav-text">Window 的创建过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-%E7%9A%84%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">Window 的添加过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PopupWindow-%E4%B8%AD%E7%9A%84-Window"><span class="nav-number">4.</span> <span class="nav-text">PopupWindow 中的 Window</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dialog-%E4%B8%AD%E7%9A%84-Window"><span class="nav-number">5.</span> <span class="nav-text">Dialog 中的 Window</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-%E7%9A%84-SoftInputMode"><span class="nav-number">6.</span> <span class="nav-text">Window 的 SoftInputMode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Vance</p>
  <div class="site-description" itemprop="description">问道有先后，如是而已。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/12/Android-Window/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Vance">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vance 的博客">
      <meta itemprop="description" content="问道有先后，如是而已。">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Android Window | Vance 的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android Window
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-12 23:54:25" itemprop="dateCreated datePublished" datetime="2022-04-12T23:54:25+08:00">2022-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-05 10:30:41" itemprop="dateModified" datetime="2023-03-05T10:30:41+08:00">2023-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <ol>
<li>Android 中所有的视图都是通过 <code>Window</code> 来呈现的，像常用的 Activity，Dialog 和 Toast 都是附加在 Window 上的，所以 <strong>Window 是 View 的直接管理者</strong>。<span id="more"></span></li>
<li>Window 是个抽象概念，每一个 Window 对应着一个 <code>ViewRootImpl</code>，Window 通过 ViewRootImpl 来和 View 建立联系。View 是 Window 存在的实体，只能通过 WindowManager 访问 Window。</li>
<li><code>WindowManager</code> 是一个接口，继承 ViewManager 接口。主要用来管理窗口的一些状态、属性，View 的添加、删除、更新、消息收集和处理等。其唯一实现类是 <code>WindowManagerImpl</code>，WindowManagerImpl 又委托给了 WindowManagerGlobal。</li>
<li><code>WindowManagerGlobal</code> 中存储着四个 List，分别是 <code>mViews</code>，<code>mRoots</code>，<code>mParams</code>，<code>mDyingViews</code>。单例模式。</li>
<li>Window 的操作通过 IPC 通信交给 WindowManagerService 操作。</li>
</ol>
<p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%20%E5%9B%BE%E4%BE%8B.png" alt="Window"></p>
<h2 id="Window-相关类"><a href="#Window-相关类" class="headerlink" title="Window 相关类"></a>Window 相关类</h2><p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20Uml.png" alt="Window Uml"></p>
<ul>
<li><strong>Window:</strong> 是一个抽象类，提供了统一的外观和行为标准。作为顶级视图添加到 WindowManager 中，View 是依附于 Window 而存在的，对 View 进行管理。View 是 window 的存在形式，window 是 view 的载体</li>
<li><strong>PhoneWindow:</strong> Window 的唯一实现类。Activity，Toast 和 Dialog 都包含 PhoneWindow 对象，PopupWindow 。</li>
<li><strong>WindowManager:</strong> 是一个接口，继承了 ViewManager（addView，updateViewLayout 和 removeView 方法） 接口，对 Window 进行管理。实现类是 WindowManagerImpl。</li>
<li><strong>WindowManagerGlobal:</strong> 单例模式。对 Window 的操作都通过它代理执行。</li>
<li><strong>ViewRootImpl:</strong> 实现了 ViewParent 接口，是 Window 和 DecorView 的桥梁，类似 <code>ActivityThread</code> 和 AMS 通信一样。内部类 W 是一个 Binder 对象，它通静态变量 <code>sWindowSession（Session 实例</code> 与 WMS 进行通信。绘制 View 和 事件传递。</li>
</ul>
<blockquote>
<p>Activity 是控制器。Window 是承载器，承载视图。DecorView 是顶层视图，负责视图部分。ViewRoot 是连接器，负责用户和 WMS 的交互。</p>
</blockquote>
<h2 id="Window-LayoutParams"><a href="#Window-LayoutParams" class="headerlink" title="Window LayoutParams"></a>Window LayoutParams</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Window.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LayoutParams</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span>.LayoutParams <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FIRST_APPLICATION_WINDOW</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TYPE_BASE_APPLICATION</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LAST_APPLICATION_WINDOW</span> <span class="operator">=</span> <span class="number">99</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FIRST_SUB_WINDOW</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LAST_SUB_WINDOW</span> <span class="operator">=</span> <span class="number">1999</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FIRST_SYSTEM_WINDOW</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LAST_SYSTEM_WINDOW</span>      <span class="operator">=</span> <span class="number">2999</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> y;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The general type of window.  There are three main classes of</span></span><br><span class="line"><span class="comment">     * window types:Application windows，Sub-windows，System windows</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> type;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Various behavioral options/flags.  Default is none.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Identifier for this window.  This will usually be filled in for you.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">IBinder</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Window-Type"><a href="#Window-Type" class="headerlink" title="Window Type"></a>Window Type</h3><p>Window 有三种类型，分别是<code>应用 Window</code>、<code>子Window</code>、<code>系统 Window</code>。<br>Window 是分层的，应用 Window 是 1-99，子 Window 是 1000-1999，系统 Window 是 2000-2999。层级大的会覆盖层级小的 Window 上面。</p>
<p><strong>应用窗口：</strong></p>
<p>Activity 对应的窗口类型是应用窗口， 所有 Activity 默认的窗口类型是 <code>TYPE_BASE_APPLICATION</code>。 WindowManager 的 LayoutParams 的默认类型是 <code>TYPE_APPLICATION</code>。 Dialog 并没有设置 type，所以也是默认的窗口类型即 TYPE_APPLICATION。</p>
<p><strong>子窗口：</strong></p>
<p>子窗口不能单独存在，它需要附属在父 Window 中，比如 PopupWindow 或 Dialog。</p>
<p><strong>系统窗口：</strong></p>
<p>一般来讲，系统窗口应该由系统来创建的，例如 ANR 时的提示框，系统状态栏，屏保等。但是，Framework 还是定义了一些，可以被应用所创建的系统窗口，如 TYPE_APPLICATION_OVERLAY。系统窗口需要相应的权限。</p>
<table>
<thead>
<tr>
<th align="left">常量值</th>
<th align="left">类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FIRST_APPLICATION_WINDOW&#x3D;1</td>
<td align="left">第一个普通应用窗口</td>
</tr>
<tr>
<td align="left">TYPE_BASE_APPLICATION&#x3D;1</td>
<td align="left">所有程序窗口的 base 窗口，其他应用程序窗口都显示在它上面</td>
</tr>
<tr>
<td align="left">TYPE_APPLICATION&#x3D;2</td>
<td align="left">普通应用程序窗口，token 必须设置为 Activity 的 token 来指定窗口属于谁</td>
</tr>
<tr>
<td align="left">TYPE_APPLICATION_STARTING&#x3D;3</td>
<td align="left">应用程序启动时先显示此窗口，当真正的窗口配置完成后，关闭此窗口</td>
</tr>
<tr>
<td align="left">LAST_APPLICATION_WINDOW&#x3D;99</td>
<td align="left">最后一个应用窗口</td>
</tr>
<tr>
<td align="left">FIRST_SUB_WINDOW &#x3D; 1000</td>
<td align="left">第一个子 Window</td>
</tr>
<tr>
<td align="left">LAST_SUB_WINDOW &#x3D; 1999</td>
<td align="left">最后一个子 Window</td>
</tr>
<tr>
<td align="left">FIRST_SYSTEM_WINDOW&#x3D;2000</td>
<td align="left">第一个系统窗口</td>
</tr>
<tr>
<td align="left">TYPE_STATUS_BAR&#x3D;2000</td>
<td align="left">状态栏，只能有一个状态栏，位于屏幕顶端</td>
</tr>
<tr>
<td align="left">TYPE_SYSTEM_DIALOG&#x3D;2008</td>
<td align="left">系统对话框</td>
</tr>
<tr>
<td align="left">TYPE_INPUT_METHOD&#x3D;2011</td>
<td align="left">输入法窗口，显示于普通应用&#x2F;子窗口之上</td>
</tr>
<tr>
<td align="left">TYPE_APPLICATION_OVERLAY&#x3D;2038</td>
<td align="left">应用弹窗</td>
</tr>
<tr>
<td align="left">LAST_SYSTEM_WINDOW&#x3D;2999</td>
<td align="left">最后一个系统窗口</td>
</tr>
</tbody></table>
<p><strong>注意：</strong><br>TYPE_PHONE、TYPE_SYSTEM_ALERT、TYPE_TOAST、TYPE_SYSTEM_OVERLAY、TYPE_PRIORITY_PHONE、TYPE_SYSTEM_ERROR 在 API 26 中已废弃，使用 TYPE_APPLICATION_OVERLAY 代替，需要申请 Manifest.permission.SYSTEM_ALERT_WINDOW 权限。<br>TYPE_KEYGUARD 已经被从系统中移除，使用 TYPE_KEYGUARD_DIALOG 代替。</p>
<h3 id="Window-Flag"><a href="#Window-Flag" class="headerlink" title="Window Flag"></a>Window Flag</h3><p>Window 属性用来控制 Window 的显示特性，这里主要介绍几个比较常用的选项：</p>
<ul>
<li><p><strong>FLAG_NOT_FOCUSABLE</strong></p>
<p>表示 Window 不需要获取焦点也不需要接收各种输入事件，此标记会同时启用 FLAG_NOT_TOUCH_MODAL，最终事件会直接传递给下层具有焦点的 Window。</p>
</li>
<li><p><strong>FLAG_NOT_TOUCH_MODAL</strong></p>
<p>系统会将当前 Window 区域以外的单击事件传递给底层的 Window，当前 Window 区域以内的单击事件则自己处理，这个标记很重要，一般来说都需要开启此标记，否则其他 Window 将无法接收点击事件。</p>
</li>
</ul>
<p>Window 类型和标记通过 WindowManager.LayoutParams 设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LayoutParams</span> <span class="keyword">extends</span> <span class="title class_">ViewGroup</span>.LayoutParams <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LayoutParams</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">        type = TYPE_APPLICATION;</span><br><span class="line">        format = PixelFormat.OPAQUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Window-Token"><a href="#Window-Token" class="headerlink" title="Window Token"></a>Window Token</h3><p>在源码中 token 一般代表的是 Binder 对象，用于 IPC 通讯。并且它也包含着此次通讯所需要的信息，在 ViewRootImpl 里，token 用来表示 mWindow(W 类，即 IWindow)，并且在 WMS 中只有符合要求的 token 才能让 Window 正常显示。</p>
<p>在 Window 中，token(LayoutParams.token)分为以下 2 种情况：</p>
<ol>
<li>应用窗口 : 表示的是 activity 的 mToken</li>
<li>子窗口 : 表示的是父窗口的 W 对象，也就是 mWindow(IWindow)</li>
</ol>
<h2 id="Window-添加-View-的过程"><a href="#Window-添加-View-的过程" class="headerlink" title="Window 添加 View 的过程"></a>Window 添加 View 的过程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="type">int</span> layoutResID)</span> &#123;</span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneWindow</span> <span class="keyword">extends</span> <span class="title class_">Window</span> <span class="keyword">implements</span> <span class="title class_">MenuBuilder</span>.Callback &#123;</span><br><span class="line">    <span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">    <span class="comment">// This is the view in which the window contents are placed. It is either</span></span><br><span class="line">    <span class="comment">// mDecor itself, or a child of mDecor where the contents go.</span></span><br><span class="line">    ViewGroup mContentParent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="type">int</span> layoutResID)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 初始化 mDecor 和 mContentParent 对象</span></span><br><span class="line">            installDecor();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Activity 转场动画</span></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Scene</span> <span class="variable">newScene</span> <span class="operator">=</span> Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 将布局资源加载到 mContentParent 中</span></span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 让 DecorView 的内容区域延伸到 systemUi 下方，达到全屏、透明状态栏的效果</span></span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Callback</span> <span class="variable">cb</span> <span class="operator">=</span> getCallback();</span><br><span class="line">        <span class="comment">// 回调 Content 变化通知</span></span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="literal">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParentExplicitlySet = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installDecor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDecor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 实例化 DecorView</span></span><br><span class="line">            mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 关联 Window</span></span><br><span class="line">            mDecor.setWindow(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//并将mContentParent绑定至 id=R.id.content 的 ViewGroup。</span></span><br><span class="line">            <span class="comment">// 绑定 id=R.id.content 的 View</span></span><br><span class="line">            mContentParent = generateLayout(mDecor);</span><br><span class="line">            <span class="comment">// 处理转场动画</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> DecorView <span class="title function_">generateDecor</span><span class="params">(<span class="type">int</span> featureId)</span> &#123;</span><br><span class="line">        <span class="comment">// 关联 Window</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DecorView</span>(context, featureId, <span class="built_in">this</span>, getAttributes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ViewGroup <span class="title function_">generateLayout</span><span class="params">(DecorView decor)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取 Window 样式</span></span><br><span class="line">        <span class="comment">// 定义在 ~\frameworks\base\core\res\res\values\attrs.xml</span></span><br><span class="line">        <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> getWindowStyle();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据样式，设置悬浮窗，titleBar，actionBar，全屏，透明状态栏等</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新 Window 参数</span></span><br><span class="line">        WindowManager.<span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> getAttributes();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> layoutResource;</span><br><span class="line">        <span class="type">int</span> <span class="variable">features</span> <span class="operator">=</span> getLocalFeatures();</span><br><span class="line">        <span class="comment">// 根据不同的 feature 加载不同的 layout 资源</span></span><br><span class="line">        <span class="keyword">if</span>(features &amp; xxx != <span class="number">0</span>)&#123;</span><br><span class="line">            layoutResource = R.layout.xxx;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 默认的 layout</span></span><br><span class="line">            layoutResource = R.layout.screen_simple;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将布局添加至 DecorView 中</span></span><br><span class="line">        mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">        <span class="type">ViewGroup</span> <span class="variable">contentParent</span> <span class="operator">=</span> (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">        <span class="comment">// 配置完成，DecorView 根据已有属性调整布局状态</span></span><br><span class="line">        mDecor.finishChanging();</span><br><span class="line">        <span class="keyword">return</span> contentParent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DecorView.java</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onResourcesLoaded</span><span class="params">(LayoutInflater inflater, <span class="type">int</span> layoutResource)</span> &#123;</span><br><span class="line">    mDecorCaptionView = createDecorCaptionView(inflater);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">View</span> <span class="variable">root</span> <span class="operator">=</span> inflater.inflate(layoutResource, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (mDecorCaptionView != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addView(root, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">ViewGroup</span>.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    &#125;</span><br><span class="line">    mContentRoot = (ViewGroup) root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- screen_simple.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_mode_bar_stub&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">&quot;@+id/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">&quot;@layout/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">&quot;?attr/actionBarTheme&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:id</span>=<span class="string">&quot;@android:id/content&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundInsidePadding</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundGravity</span>=<span class="string">&quot;fill_horizontal|top&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foreground</span>=<span class="string">&quot;?android:attr/windowContentOverlay&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>首次调用 Activity#setContentView() 时通过 installDecor() 方法初始化 mDecor 和 mContentParent(R.id.content) 对象。<ul>
<li>generateDecor() 创建 DecorView 对象。</li>
<li>generateLayout(mDecor) 填充布局。首先根据当前的主题设置相关 feature，获取布局文件（默认为 screen_simple.xml），然后将布局添加到 DecorView 中，并将 mContentParent 与布局中 id&#x3D;R.id.content 的 FrameLayout 绑定。</li>
</ul>
</li>
<li>如果设置了 FEATURE_CONTENT_TRANSITIONS，就会创建 Scene 完成转场动画；否则使用布局填充器将布局文件填充至 mContentParent。Activity 的布局文件也就添加到 DecorView 里面了。</li>
</ol>
<p><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20setContentView.png" alt="Activity setContentView"></p>
<h3 id="Window-的创建过程"><a href="#Window-的创建过程" class="headerlink" title="Window 的创建过程"></a>Window 的创建过程</h3><p>Activity 通过 ClassLoader 实例化后调用 Activity#attach() 方法，在该方法中创建 PhoneWindow 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ActivityThread</span> <span class="keyword">extends</span> <span class="title class_">ClientTransactionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Activity <span class="title function_">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> &#123;</span><br><span class="line">        activity.attach(appContext, <span class="built_in">this</span>, getInstrumentation(), ...);</span><br><span class="line">        <span class="comment">//回调 Activity#onCreate() 方法</span></span><br><span class="line">        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 AMS 启动 Activity，回调 performLaunchActivity() 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Activity</span> <span class="keyword">extends</span> <span class="title class_">ContextThemeWrapper</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Window</span>.Callback, Window.OnWindowDismissedCallback ...&#123;</span><br><span class="line">    <span class="keyword">private</span> Thread mUiThread;</span><br><span class="line">    ActivityThread mMainThread;</span><br><span class="line">    <span class="keyword">private</span> IBinder mToken;</span><br><span class="line">    <span class="keyword">private</span> Window mWindow;</span><br><span class="line">    <span class="keyword">private</span> WindowManager mWindowManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">(Context context, ActivityThread aThread, IBinder token,...)</span>&#123;</span><br><span class="line">        <span class="comment">// 实例化 PhoneWindow 对象</span></span><br><span class="line">        mWindow = <span class="keyword">new</span> <span class="title class_">PhoneWindow</span>(<span class="built_in">this</span>, window, activityConfigCallback);</span><br><span class="line">        <span class="comment">// 设置回调，接收事件、Window Attached 和 Detached、内容改变通知</span></span><br><span class="line">        mWindow.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(<span class="built_in">this</span>);</span><br><span class="line">        mMainThread = aThread;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, ...);</span><br><span class="line">        mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getSystemService</span><span class="params">(<span class="meta">@ServiceName</span> <span class="meta">@NonNull</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (WINDOW_SERVICE.equals(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> mWindowManager;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SEARCH_SERVICE.equals(name)) &#123;</span><br><span class="line">            ensureSearchManager();</span><br><span class="line">            <span class="keyword">return</span> mSearchManager;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getSystemService(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Activity#onCreate() 方法里，我们通过 setContentView() 将 view 添加到 PhoneWindow 的 mContentParent(R.id.content) 中，也就是将资源布局文件和 PhoneWindow 关联。虽然 Window 和 DecorView 已经创建并初始化完毕，但这个时候的 DecorView 还没有被 WindowManager 添加到 Window 中。</p>
<h3 id="Window-的添加过程"><a href="#Window-的添加过程" class="headerlink" title="Window 的添加过程"></a>Window 的添加过程</h3><p>PhoneWindow 只是负责处理一些应用窗口通用的逻辑(设置标题栏，导航栏等)。真正完成把一个 View 作为窗口添加到 WMS 的过程是由 WindowManager 来完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleResumeActivity</span><span class="params">(IBinder token, ...)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ActivityClientRecord</span> <span class="variable">r</span> <span class="operator">=</span> performResumeActivity(token, ...);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">a</span> <span class="operator">=</span> r.activity;</span><br><span class="line">    <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">        r.window = r.activity.getWindow();</span><br><span class="line">        <span class="type">View</span> <span class="variable">decor</span> <span class="operator">=</span> r.window.getDecorView();</span><br><span class="line">        <span class="comment">// 隐藏 DecorView</span></span><br><span class="line">        decor.setVisibility(View.INVISIBLE);</span><br><span class="line">        <span class="comment">// 获取 WMS</span></span><br><span class="line">        <span class="type">ViewManager</span> <span class="variable">wm</span> <span class="operator">=</span> a.getWindowManager();</span><br><span class="line">        WindowManager.<span class="type">LayoutParams</span> <span class="variable">l</span> <span class="operator">=</span> r.window.getAttributes();</span><br><span class="line">        a.mDecor = decor;</span><br><span class="line">        <span class="comment">// Activity 窗口类型为 TYPE_BASE_APPLICATION</span></span><br><span class="line">        l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 把 DecorView 添加到窗口上</span></span><br><span class="line">                wm.addView(decor, l);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp;</span><br><span class="line">            r.activity.mDecor != <span class="literal">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">            <span class="comment">// 显示 DecorView</span></span><br><span class="line">            r.activity.makeVisible();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 WindowManagerImpl 将 DecorView 添加到窗口上 <code>wm.addView(decor, l)</code>，又交给了 WindowManagerGlobal 添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WindowManagerGlobal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IWindowManager sWindowManagerService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IWindowSession sWindowSession;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span><br><span class="line"><span class="params">            Display display, Window parentWindow, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="comment">// parentWindow 即 PhoneWindow</span></span><br><span class="line">        <span class="keyword">if</span> (parentWindow != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 根据窗口类型设置 token，titile等参数</span></span><br><span class="line">            parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ViewRootImpl root;</span><br><span class="line">        <span class="type">View</span> <span class="variable">panelParentView</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// 查找子 Window 的父 Window</span></span><br><span class="line">            <span class="keyword">if</span> (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</span><br><span class="line">                    wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> mViews.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</span><br><span class="line">                        panelParentView = mViews.get(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            root = <span class="keyword">new</span> <span class="title class_">ViewRootImpl</span>(view.getContext(), display);</span><br><span class="line">            view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">            mViews.add(view);</span><br><span class="line">            mRoots.add(root);</span><br><span class="line">            mParams.add(wparams);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行 view 绘制流程，并添加到 window上</span></span><br><span class="line">            root.setView(view, wparams, panelParentView, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IWindowManager <span class="title function_">getWindowManagerService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowManagerService == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 通过 ServiceManager 获取 IWindowManager 的 proxy</span></span><br><span class="line">                sWindowManagerService = IWindowManager.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(<span class="string">&quot;window&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowManagerService;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title function_">getWindowSession</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowSession == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">IWindowManager</span> <span class="variable">windowManager</span> <span class="operator">=</span> getWindowManagerService();</span><br><span class="line">                <span class="comment">// 通过 WMS 实例化 Session 对象</span></span><br><span class="line">                sWindowSession = windowManager.openSession(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">IWindowSessionCallback</span>.Stub() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimatorScaleChanged</span><span class="params">(<span class="type">float</span> scale)</span> &#123;</span><br><span class="line">                                ValueAnimator.setDurationScale(scale);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowSession;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着通过 ViewRootImpl#setView() 设置 DecorView。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title class_">ViewParent</span> ...&#123;</span><br><span class="line">    <span class="keyword">final</span> IWindowSession mWindowSession;</span><br><span class="line">    <span class="keyword">final</span> View.AttachInfo mAttachInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, display, WindowManagerGlobal.getWindowSession(), <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> useSfChoreographer)</span> &#123;</span><br><span class="line">        mWindowSession = session;</span><br><span class="line">        mWindow = <span class="keyword">new</span> <span class="title class_">W</span>(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// 创建 AttachInfo 对象</span></span><br><span class="line">        mAttachInfo = <span class="keyword">new</span> <span class="title class_">View</span>.AttachInfo(mWindowSession, mWindow ...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, ...)</span> &#123;</span><br><span class="line">        mView = view;</span><br><span class="line">        mAdded = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">        <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">        <span class="comment">// any other events from the system.</span></span><br><span class="line">        requestLayout();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mWindowSession 是一个 Binder 对象</span></span><br><span class="line">        <span class="comment">// 返回 WindowManagerGlobal.ADD_OKAY=0 表示添加窗口成功，其他 12 种错误码都是负数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mWindowSession.addToDisplayAsUser(mWindow, ...)</span><br><span class="line">        <span class="keyword">if</span> (res &lt; WindowManagerGlobal.ADD_OKAY) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (res) &#123;</span><br><span class="line">                <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_APP_TOKEN:</span><br><span class="line">                <span class="keyword">case</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WindowManager</span>.BadTokenException(</span><br><span class="line">                            <span class="string">&quot;Unable to add window -- token &quot;</span> + attrs.token</span><br><span class="line">                            + <span class="string">&quot; is not valid; is your activity running?&quot;</span>);</span><br><span class="line">                <span class="keyword">case</span> WindowManagerGlobal.ADD_DUPLICATE_ADD:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WindowManager</span>.BadTokenException(</span><br><span class="line">                            <span class="string">&quot;Unable to add window -- window &quot;</span> + mWindow</span><br><span class="line">                            + <span class="string">&quot; has already been added&quot;</span>);</span><br><span class="line">                <span class="keyword">case</span> WindowManagerGlobal.ADD_PERMISSION_DENIED:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WindowManager</span>.BadTokenException(<span class="string">&quot;Unable to add window &quot;</span></span><br><span class="line">                            + mWindow + <span class="string">&quot; -- permission denied for window type &quot;</span></span><br><span class="line">                            + mWindowAttributes.type);</span><br><span class="line">                <span class="keyword">case</span> WindowManagerGlobal.ADD_INVALID_TYPE:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WindowManager</span>.InvalidDisplayException(<span class="string">&quot;Unable to add window &quot;</span></span><br><span class="line">                            + mWindow + <span class="string">&quot; -- the specified window type &quot;</span></span><br><span class="line">                            + mWindowAttributes.type + <span class="string">&quot; is not valid&quot;</span>);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                    <span class="string">&quot;Unable to add window -- unknown error code &quot;</span> + res);</span><br><span class="line">        ｝</span><br><span class="line">        <span class="comment">// DecorView 的 parent 是 ViewRootImpl</span></span><br><span class="line">        view.assignParent(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 应用端 W 的实例 mWindow 在应用进程是 native 端，用来监听窗口变化。</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">W</span> <span class="keyword">extends</span> <span class="title class_">IWindow</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insetsChanged</span><span class="params">(InsetsState insetsState)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mWindowSession 通过 <code>WindowManagerGlobal.getWindowSession()</code> 方法获取，是一个 Binder 对象。因为 WindowManagerGlobal 是单例，所以 mWindowSession 对象每个进程只有一个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class represents an active client session.  There is generally one</span></span><br><span class="line"><span class="comment"> * Session object per process that is interacting with the window manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Session</span> <span class="keyword">extends</span> <span class="title class_">IWindowSession</span>.Stub <span class="keyword">implements</span> <span class="title class_">IBinder</span>.DeathRecipient &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Session</span><span class="params">(WindowManagerService service, IWindowSessionCallback callback)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addToDisplayAsUser</span><span class="params">(IWindow window, ...)</span> &#123;</span><br><span class="line">        <span class="comment">// 通过 WMS 添加窗口</span></span><br><span class="line">        <span class="keyword">return</span> mService.addWindow(<span class="built_in">this</span>, window, seq, ...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一个 Session 在 WidowManagerService 里代表一个与应用进程打开的会话连接，每个进程只有一个 Session 对象。最终 Session 通过 IPC 通信，请求 WMS 添加 Window，并由 W 类接收通知。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WindowManagerService</span> <span class="keyword">extends</span> <span class="title class_">IWindowManager</span>.Stub...&#123;</span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="keyword">new</span> <span class="title class_">ArraySet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> HashMap&lt;IBinder, WindowState&gt; mWindowMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    WindowManagerPolicy mPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addWindow</span><span class="params">(Session session, IWindow client, ...)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mPolicy 是 PhoneWindowManager 实例化</span></span><br><span class="line">        <span class="comment">// 根据 type 检查窗口类型是否合法，如果是系统窗口类型，还需要进行权限检查</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mPolicy.checkAddPermission(attrs.type, ...);</span><br><span class="line">        <span class="keyword">if</span> (res != WindowManagerGlobal.ADD_OKAY) &#123;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type &gt;= FIRST_SUB_WINDOW &amp;&amp; type &lt;= LAST_SUB_WINDOW) &#123;</span><br><span class="line">            <span class="comment">// 父窗口不存在或父窗口也是子窗口，返回 ADD_BAD_SUBWINDOW_TOKEN</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 一系列 type 判断</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个 WindowState 对象，用于 WMS 表示一个窗口的对象</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">WindowState</span> <span class="variable">win</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WindowState</span>(<span class="built_in">this</span>, session, client, token, ...);</span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_TOAST) &#123;</span><br><span class="line">            mH.sendMessageDelayed(</span><br><span class="line">                mH.obtainMessage(H.WINDOW_HIDE_TIMEOUT, win),</span><br><span class="line">                win.mAttrs.hideTimeoutMilliseconds);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = WindowManagerGlobal.ADD_OKAY;</span><br><span class="line">        <span class="comment">// 将 Session 添加到 mSessions 集合中</span></span><br><span class="line">        win.attach();</span><br><span class="line">        mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Window 的添加请求就交给 WMS 去处理了，在 WMS 内部会为每一个应用保留一个单独的 Session，同时会创建一个 WindowState 对象来表示当前添加的窗口。<br>无论是应用窗口还是子窗口，token 不能为空。否则会抛出异常，并且应用窗口的 token 必须是某个 Activity 的 mToken，子窗口的 token 必须是父窗口的 IWindow 对象，而且子窗口还需等父窗口添加成功之后才可添加到 Window 上。</p>
<p>Window 添加流程图如下：<br><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%E6%B7%BB%E5%8A%A0%E6%B5%81%E7%A8%8B.png" alt="Window 添加过程"><br><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20%E6%B7%BB%E5%8A%A0%20IPC%20%E4%BA%A4%E4%BA%92.png" alt="添加 Window IPC 交互"><br><img src="https://my-android.oss-cn-shanghai.aliyuncs.com/img/Android%20Window%20WindowState.png" alt="WindowState"></p>
<h2 id="PopupWindow-中的-Window"><a href="#PopupWindow-中的-Window" class="headerlink" title="PopupWindow 中的 Window"></a>PopupWindow 中的 Window</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PopupWindow</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PopupWindow</span><span class="params">(Context context, AttributeSet attrs, ...)</span> &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据默认样式设置属性</span></span><br><span class="line">        <span class="comment">// 设置显示和隐藏动画</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(View contentView)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isShowing()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mContentView = contentView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showAsDropDown</span><span class="params">(View anchor, <span class="type">int</span> xoff, <span class="type">int</span> yoff, <span class="type">int</span> gravity)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isShowing() || !hasContentView()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        attachToAnchor(anchor, xoff, yoff, gravity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowManager.<span class="type">LayoutParams</span> <span class="variable">p</span> <span class="operator">=</span></span><br><span class="line">                createPopupLayoutParams(anchor.getApplicationWindowToken());</span><br><span class="line">        preparePopup(p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否显示 anchorView 的上面</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">aboveAnchor</span> <span class="operator">=</span> findDropDownPosition(anchor, ...);</span><br><span class="line">        updateAboveAnchor(aboveAnchor);</span><br><span class="line"></span><br><span class="line">        invokePopup(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">preparePopup</span><span class="params">(WindowManager.LayoutParams p)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContentView == <span class="literal">null</span> || mContext == <span class="literal">null</span> || mWindowManager == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;You must specify a valid content view by &quot;</span></span><br><span class="line">                    + <span class="string">&quot;calling setContentView() before attempting to show the popup.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mDecorView = createDecorView(mBackgroundView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PopupDecorView <span class="title function_">createDecorView</span><span class="params">(View contentView)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">PopupDecorView</span> <span class="variable">decorView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PopupDecorView</span>(mContext);</span><br><span class="line">        decorView.addView(contentView, MATCH_PARENT, height);</span><br><span class="line">        <span class="keyword">return</span> decorView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invokePopup</span><span class="params">(WindowManager.LayoutParams p)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">PopupDecorView</span> <span class="variable">decorView</span> <span class="operator">=</span> mDecorView;</span><br><span class="line">        mWindowManager.addView(decorView, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dismiss</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isShowing() || isTransitioningToDismiss()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有动画，退出动画执行完毕后再 dismissImmediate()</span></span><br><span class="line">        <span class="comment">// 通过 mWindowManager 移除 View</span></span><br><span class="line">        dismissImmediate(decorView, contentHolder, contentView);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除相关监听器</span></span><br><span class="line">        detachFromAnchor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//回调 onDismiss() 方法</span></span><br><span class="line">        <span class="keyword">if</span> (mOnDismissListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            mOnDismissListener.onDismiss();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PopupDecorView</span> <span class="keyword">extends</span> <span class="title class_">FrameLayout</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>创建 PopupWindow，设置 ContentView 等其他属性。</li>
<li>调用 showAtLocation() 或 showAsDropDown() 方法，通过 WindowManager 添加 View。</li>
</ol>
<p>注意：PopupWindow 并没有创建 PhoneWindow 对象。它和 Activity 在同一层级，不会在 Activity 上方。</p>
<h2 id="Dialog-中的-Window"><a href="#Dialog-中的-Window" class="headerlink" title="Dialog 中的 Window"></a>Dialog 中的 Window</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dialog</span> <span class="keyword">implements</span> <span class="title class_">DialogInterface</span>, Window.Callback,</span><br><span class="line">        KeyEvent.Callback, OnCreateContextMenuListener, Window.OnWindowDismissedCallback &#123;</span><br><span class="line"></span><br><span class="line">    Dialog(<span class="meta">@NonNull</span> Context context, <span class="meta">@StyleRes</span> <span class="type">int</span> themeResId,...) &#123;</span><br><span class="line">        mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Window</span> <span class="variable">w</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PhoneWindow</span>(mContext);</span><br><span class="line">        mWindow = w;</span><br><span class="line">        w.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        w.setOnWindowDismissedCallback(<span class="built_in">this</span>);</span><br><span class="line">        w.setOnWindowSwipeDismissedCallback(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCancelable) &#123;</span><br><span class="line">                cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        w.setWindowManager(mWindowManager, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        w.setGravity(Gravity.CENTER);</span><br><span class="line"></span><br><span class="line">        mListenersHandler = <span class="keyword">new</span> <span class="title class_">ListenersHandler</span>(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="meta">@NonNull</span> View view)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 DecorView</span></span><br><span class="line">        mWindow.setContentView(view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mShowing) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDecor != <span class="literal">null</span>) &#123;</span><br><span class="line">                mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCanceled = <span class="literal">false</span>;</span><br><span class="line">        dispatchOnCreate(<span class="literal">null</span>);</span><br><span class="line">        onStart();</span><br><span class="line">        mDecor = mWindow.getDecorView();</span><br><span class="line">        WindowManager.<span class="type">LayoutParams</span> <span class="variable">l</span> <span class="operator">=</span> mWindow.getAttributes();</span><br><span class="line">        mWindowManager.addView(mDecor, l);</span><br><span class="line">        mShowing = <span class="literal">true</span>;</span><br><span class="line">        sendShowMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ListenersHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dialog 是子窗口，依赖 Activity，需要 Activity 的 token，如果传递 ApplicationContext 会报 <code>android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?</code> 错误。</p>
<h2 id="Window-的-SoftInputMode"><a href="#Window-的-SoftInputMode" class="headerlink" title="Window 的 SoftInputMode"></a>Window 的 SoftInputMode</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>在 Window 系统中，分为两部分的内容：一部分是运行在系统服务进程的 WMS 及相关类，WMS 用 WindowState 来描述一个窗口；另一部分是运行在应用进程的 WindowManagerImpl, WindowManagerGlobal，ViewRootImpl 等相关类。</li>
<li>对于 WMS 来讲，窗口对应一个 View 对象，而不是 Window 对象。</li>
<li>Window 是抽象类，描述是一类具有某种通用特性的窗口，唯一实现类是 PhoneWindow。PhoneWindow 类把一些操作的统一处理了，例如长按，按”Back”键等。</li>
<li>Android Framework 把窗口分为三种类型，应用窗口，子窗口以及系统窗口。不同类型的窗口在执行添加窗口操作时，对于 WindowManager.LayoutParams 的 token 参数有不同的要求。<br>应用窗口必须是某个有效的 Activity 的 mToken；子窗口的 token 必须是父窗口的 ViewRootImpl 中的 W 对象；有些系统窗口不需要 token，有些系统窗口的 token 必须满足一定的要求。</li>
<li>只能通过 Context.getSystemServer() 来获取 WindowManager。Activity 返回 mWindowManager，即 WindowManagerImpl。</li>
<li>在调用 WindowManagerImpl 的 addView 之前，如果没有给 token 赋值，则会走默认的 token 赋值逻辑。<br>默认的 token 是如果 mParentWindow 不为空，则会调用其 adjustLayoutParamsForSubWindow() 方法。在 adjustLayoutParamsForSubWindow() 方法中，如果当前要添加的窗口是应用窗口，如果其 token 为空，则会把当前 PhoneWindow 的 mToken 赋值给 token。如果是子窗口，则会把当前 PhonwWindow 对应的 DecorView 的 mAttachInfo 中的 mWindowToken 赋值给 token。而 View 中的 mAttachIno 来自 ViewRootImpl 的 mAttachInfo。因此这个 token 本质就是父窗口的 ViewRootImpl 中的 W 类对象。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/qian520ao/article/details/78555397#setcontentview">[1] Android Window 机制探索</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/geyunfei_/article/details/105628579?spm=1001.2014.3001.5501">[2] Android 窗口创建流程</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Window/" rel="tag"># Window</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/02/Android-Jetpack-%E4%B9%8B-Lifecycle-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="prev" title="Android Jetpack 之 Lifecycle 源码分析">
                  <i class="fa fa-chevron-left"></i> Android Jetpack 之 Lifecycle 源码分析
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/13/Android-%E5%B1%8F%E5%B9%95%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6-Choreographer-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" rel="next" title="Android 屏幕刷新机制 Choreographer 原理分析">
                  Android 屏幕刷新机制 Choreographer 原理分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vance</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
